---
dimg: 'component'
from: 'fedora:27'
docker:
  ENV: 
    TZ: Europe/Kiev
  USER: 'penstock:penstock'
  WORKDIR: '/opt/penstock'
  CMD: 
    - bin/penstock
    - etc/penstock.yaml
mount: 
  - to: '/var/cache/dnf'
    from: build_dir

git:
  - add: /
    to: /opt/penstock
    owner: penstock
    group: penstock
    stageDependencies:
      beforeSetup: 
        - '*'
ansible:
  beforeInstall:
    - raw: dnf install --nodocs gcc python2-virtualenv libyaml libffi -y
    - group:
        name: penstock
        state: present
    - user:
        name: penstock
        shell: /bin/bash
        home: /opt/penstock
        groups: 
          - penstock
          - wheel
        password: penstock
  install:
    - pip:
        requirements: /opt/penstock/requirements.txt
        virtualenv: /opt/penstock
      become_user: penstock
  beforeSetup:
    - shell: bin/buildout
      args:
        chdir: /opt/penstock
      become_user: penstock
---
dimg: 'rpm'
fromDimg: 'component'
mount: 
  - to: '/var/cache/dnf'
    from: build_dir
docker:
  ENV: 
    TZ: Europe/Kiev
  USER: 'root:root'
  WORKDIR: '/root'
  CMD: 
    - bash
ansible:
  beforeInstall:
    - raw: dnf install --nodocs rpm-build -y
    - copy:
        src: '/opt/penstock/rpm/penstock.spec'
        dest: '/root/penstock.spec'
    - shell: 'rpmbuild -ba /root/penstock.spec'
      args:
        chdir: '/root'
